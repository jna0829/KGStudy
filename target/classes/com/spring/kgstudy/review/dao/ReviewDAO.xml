<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.kgstudy.review.dao.ReviewDAO">
	
	<resultMap type="com.spring.kgstudy.review.vo.ReviewVO" id="ReviewVO">
		<result property="review_id" column="review_id" />
		<result property="user_id" column="user_id" />
		<result property="store_id" column="store_id" />
		<result property="store_name" column="store_name" />
		<result property="reservation_id" column="reservation_id" />
		<result property="review_date" column="review_date" />
		<result property="review_content" column="review_content" />
		<result property="review_filename" column="review_filename" />
		<result property="review_star" column="review_star" />
	</resultMap>
	
	<sql id="search">
		<if test="type=='review_star'">
			where store_name like '%' || #{keyword} || '%' ORDER BY review_star DESC
		</if>
		<if test="type=='review_date'">
			where store_name like '%' || #{keyword} || '%' ORDER BY review_date DESC
		</if> 
	</sql>
	
	
	<select id="getAllReview" resultMap="ReviewVO">
		SELECT * FROM review
		 <include refid="search"/>
	</select>
	
	<select id="findList" resultMap="ReviewVO">
		select * from review
		where user_id = #{user_id}
	</select>
	
	<select id="revIdfind" resultType="com.spring.kgstudy.reservation.vo.ReservationVO">
		SELECT *
		FROM (
		  SELECT A.*, ROW_NUMBER() OVER (ORDER BY reservation_day DESC) AS rn
		  FROM reservation_table A
		  WHERE user_id = #{user_id}
		) 
		WHERE rn = 1
	</select>
	
	<select id="findReservId" resultType="int">
		select count(*) from review 
		where reservation_id = #{reservation_id}
	</select>
	
	<insert id="reviewInsert">
		insert into review
		values (review_seq.NEXTVAL, #{user_id}, #{store_id}, #{store_name}, #{reservation_id}, sysdate, #{review_content}, #{review_filename}, #{review_star} )	
	</insert>
	

</mapper>